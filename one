<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>YumYum ‚Äî TasteLink Park (Prototype)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Minimal Luxury: Black & Gold theme -->
<style>
:root{
  --bg:#0b0b0b;
  --card:#0f0f10;
  --muted:#bdbdbd;
  --gold:#c9a84b;
  --accent:#ffd97d;
  --glass: rgba(255,255,255,0.03);
  --radius:14px;
  --shadow: 0 8px 30px rgba(0,0,0,0.6);
  --safe-pad: env(safe-area-inset-bottom);
  --font-sans: 'Inter', system-ui, -apple-system, "SF Pro Text", "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404 0%, #0b0b0b 100%);color:#fff;font-family:var(--font-sans)}
a{color:var(--gold);text-decoration:none}
.container{max-width:720px;margin:0 auto;padding:16px;padding-bottom:calc(16px + var(--safe-pad))}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.logo{
  width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--gold),#ffd77a);
  display:flex;align-items:center;justify-content:center;color:#111;font-weight:800;font-size:18px;box-shadow:0 6px 18px rgba(201,168,75,0.12)
}
.h-title{font-weight:700;font-size:18px}
.h-sub{color:var(--muted);font-size:12px}

/* NAV */
.nav{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:12px}
.tab{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:600; font-size:13px}
.tab.active{background:linear-gradient(90deg, rgba(201,168,75,0.12), rgba(255,217,125,0.06));color:var(--gold);border-color:rgba(201,168,75,0.22);box-shadow:var(--shadow)}

/* main card */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}
.small{padding:8px}
.center{text-align:center}

/* Park view */
.park{
  margin-top:12px;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  height:420px;border-radius:12px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03)
}
.park .ground{
  position:absolute;left:0;right:0;bottom:0;height:38%;background:linear-gradient(180deg,#0f0f10,#060606);transform:skewY(-3deg);transform-origin:left;opacity:0.9
}
.park .tree{
  position:absolute;left:8px;top:18px;width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,#153, #0b5345);opacity:0.06;filter:blur(6px)
}

/* Avatar */
.avatar{
  position:absolute;bottom:10%;width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;color:#111;
  background:linear-gradient(180deg,var(--accent),var(--gold));box-shadow:0 8px 24px rgba(201,168,75,0.12);transition:transform .25s ease, box-shadow .25s;cursor:pointer;border:2px solid rgba(255,255,255,0.06)
}
.avatar:hover{transform:translateY(-6px) scale(1.03);box-shadow:0 16px 40px rgba(201,168,75,0.18)}
.avatar.small{width:44px;height:44px;font-size:18px}

/* bubble */
.bubble{
  position:absolute;transform:translate(-50%,-120%);min-width:120px;padding:8px 12px;border-radius:12px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.45));border:1px solid rgba(255,255,255,0.04);color:#fff;font-size:13px;opacity:0;pointer-events:none;
  transition:opacity .25s ease, transform .18s ease;
}
.bubble.visible{opacity:1;pointer-events:auto;transform:translate(-50%,-140%)}

/* feed */
.feed{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.post{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);display:flex;gap:10px}
.post .meta{font-size:12px;color:var(--muted)}

/* restaurants */
.rest-list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
.rest{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center;cursor:pointer}
.rest img{width:56px;height:56px;border-radius:8px;object-fit:cover}
.rest .name{font-weight:700}
.tag{padding:6px 8px;border-radius:999px;background:rgba(201,168,75,0.12);color:var(--gold);font-weight:700;font-size:12px}

/* chat */
.chat{
  position:fixed;right:12px;bottom:calc(12px + var(--safe-pad));width:92%;max-width:420px;z-index:60;
}
.chat-box{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 30px rgba(0,0,0,0.6)}
.chat-messages{max-height:220px;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:6px}
.chat-input{display:flex;gap:8px;margin-top:8px}
.input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}

/* small */
.row{display:flex;gap:8px;align-items:center}
.muted{color:var(--muted);font-size:13px}

/* bottom nav */
.bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px;border-radius:999px;display:flex;gap:8px;z-index:70;border:1px solid rgba(255,255,255,0.03)}
.icon-btn{width:48px;height:48px;border-radius:12px;background:transparent;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:700;border:1px solid rgba(255,255,255,0.02)}
.icon-btn.active{color:var(--gold);border-color:rgba(201,168,75,0.18);box-shadow:0 8px 24px rgba(201,168,75,0.06)}

/* responsive */
@media(min-width:720px){
  .container{padding:24px}
  .park{height:520px}
  .rest-list{grid-template-columns:repeat(3,1fr)}
}

/* simple fade-in */
.fade-in{animation:fadeIn .45s ease both}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">TL</div>
    <div>
      <div class="h-title">TasteLink ‚Äî YumYum Park</div>
      <div class="h-sub">Real Voices ¬∑ Real Taste ‚Äî Virtual Park (Mobile)</div>
    </div>
    <div style="margin-left:auto" id="userArea" class="muted">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</div>
  </div>

  <!-- NAV -->
  <div class="nav">
    <div style="display:flex;gap:8px">
      <div id="tabPark" class="tab active" onclick="showPage('park')">‡∏™‡∏ß‡∏ô (Park)</div>
      <div id="tabList" class="tab" onclick="showPage('list')">‡∏£‡πâ‡∏≤‡∏ô</div>
      <div id="tabFeed" class="tab" onclick="showPage('feed')">‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏ï‡∏µ‡πâ</div>
    </div>
    <div class="row">
      <div class="tag">Gold ‚Ä¢ Beta</div>
    </div>
  </div>

  <!-- Avatar creation card -->
  <div id="cardCreate" class="card small fade-in" style="display:none;margin-bottom:12px">
    <div style="display:flex;gap:12px;align-items:center">
      <div id="previewAvatar" style="width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#111;font-weight:700;font-size:26px"></div>
      <div style="flex:1">
        <div style="font-weight:700">‡∏™‡∏£‡πâ‡∏≤‡∏á Avatar ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
        <div class="muted">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</div>
      </div>
      <div>
        <button class="tab" onclick="openCreate()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>

  <!-- Park -->
  <div id="page-park">
    <div class="card park" id="parkArea">
      <div class="tree"></div>
      <div class="ground"></div>
      <!-- avatars inserted by JS -->
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <div class="card" style="flex:1">
        <div style="font-weight:700">‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏£‡∏≠‡∏ö ‡πÜ</div>
        <div class="muted">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ö‡∏ô‡∏™‡∏ß‡∏ô‡πÅ‡∏•‡∏∞ feed</div>
      </div>
      <div class="card small" style="width:120px;text-align:center">
        <div style="font-weight:700">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
        <div id="scoreTotal" class="muted">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- List -->
  <div id="page-list" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì</div>
        <div class="muted">Tap to view detail</div>
      </div>

      <div class="rest-list" id="restList"></div>
    </div>
  </div>

  <!-- Feed -->
  <div id="page-feed" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Community Feed</div>
        <div class="muted">Latest reviews & posts</div>
      </div>
      <div class="feed" id="feedList"></div>
    </div>
  </div>

</div>

<!-- Chat (floating) -->
<div class="chat" id="chatRoot" style="display:none">
  <div class="chat-box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">‡∏Å‡∏•‡∏∏‡πà‡∏° Chat</div>
      <div class="muted">iOS ‚Ä¢ Mobile</div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="chatInput" class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
      <button class="btn" onclick="sendChat()">‡∏™‡πà‡∏á</button>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <div id="btnPark" class="icon-btn active" onclick="showPage('park')">üèûÔ∏è</div>
  <div id="btnList" class="icon-btn" onclick="showPage('list')">üçΩÔ∏è</div>
  <div id="btnFeed" class="icon-btn" onclick="showPage('feed')">üí¨</div>
  <div id="btnCreate" class="icon-btn" onclick="openCreate()">‚úèÔ∏è</div>
</div>

<!-- Create / Modal (simple) -->
<div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;z-index:100">
  <div style="width:100%;max-width:520px;border-radius:12px;padding:16px;background:linear-gradient(180deg,#101010,#0b0b0b);border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(0,0,0,0.7)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:800">‡∏™‡∏£‡πâ‡∏≤‡∏á / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Avatar</div>
      <div class="muted" style="font-size:13px">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div id="modalPreview" style="width:84px;height:84px;border-radius:12px;background:linear-gradient(180deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#111;font-weight:800;font-size:36px"></div>
      <div style="flex:1">
        <label class="muted">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á</label>
        <input id="avatarName" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô Time" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:white"/>
        <label class="muted" style="margin-top:8px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="tab" onclick="chooseFace('üôÇ')">üôÇ</button>
          <button class="tab" onclick="chooseFace('üòé')">üòé</button>
          <button class="tab" onclick="chooseFace('üòã')">üòã</button>
          <button class="tab" onclick="chooseFace('ü¶ä')">ü¶ä</button>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn-outline" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn" onclick="saveAvatar()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- bubble template (hidden) -->
<div id="bubbleTemplate" style="display:none">
  <div class="bubble"></div>
</div>

<script>
/* ------------------------------
  Prototype JS: Park + Avatar + Feed
   - Single-file prototype (localStorage)
   - Mobile-first (iOS-friendly)
   - Animations, avatar bubbles, chat
   ------------------------------ */

const STORAGE_KEY = 'taste_link_proto_v2';

// sample restaurants data
const DEFAULT = {
  user: null,
  restaurants: [
    {id:'r1',name:'‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏à‡πä‡πÅ‡∏î‡∏á',img:'https://images.unsplash.com/photo-1604908176545-4e9e3b2a7f3c?q=80&w=800&auto=format&fit=crop',category:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢',rating:4.3,menus:[{name:'‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≥‡∏ï‡∏Å',price:40},{name:'‡πÄ‡∏Å‡∏≤‡πÄ‡∏´‡∏•‡∏≤‡∏´‡∏°‡∏π',price:45}]},
    {id:'r2',name:'‡∏Æ‡∏≤‡∏•‡∏≤‡∏•‡∏ã‡∏≠‡∏™‡πÄ‡∏î‡∏ä',img:'https://images.unsplash.com/photo-1601050690594-6d1b1c1f3b02?q=80&w=800&auto=format&fit=crop',category:'‡∏Æ‡∏≤‡∏•‡∏≤‡∏•',rating:4.6,menus:[{name:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏Å‡πà‡∏Æ‡∏≤‡∏•‡∏≤‡∏•',price:55}]},
    {id:'r3',name:'‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏Å‡∏á‡πÅ‡∏°‡πà‡∏•‡∏¥‡∏ô',img:'https://images.unsplash.com/photo-1542736667-069246bdbc27?q=80&w=800&auto=format&fit=crop',category:'‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏Å‡∏á',rating:4.1,menus:[{name:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏°‡∏π‡∏ó‡∏≠‡∏î',price:50}]}
  ],
  avatars: [
    // sample avatars to populate the park (other users)
    {id:'a1',name:'Neko',face:'üò∫',x:14,y:60,post:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å!'},
    {id:'a2',name:'Mint',face:'üòé',x:40,y:62,post:'‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Æ‡∏≤‡∏•‡∏≤‡∏•!'},
    {id:'a3',name:'JJ',face:'üôÇ',x:72,y:58,post:'‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡πâ‡∏≥‡∏ï‡∏Å ‡πÄ‡∏à‡πâ‡∏°‡∏à‡πâ‡∏ô'}
  ],
  feed: [
    // feed posts: user/ avatarId, restId, text
  ],
  chat: []
};

let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || DEFAULT;
saveState();

// UI refs
const parkArea = document.getElementById('parkArea');
const feedList = document.getElementById('feedList');
const restList = document.getElementById('restList');
const userArea = document.getElementById('userArea');
const chatRoot = document.getElementById('chatRoot');

// load initial
renderUser();
renderPark();
renderRestList();
renderFeed();
renderScore();
initChatUI();

// ========== helpers ==========
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
function showPage(page){
  // tabs and bottom nav active state
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.icon-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tabPark').classList.remove('active');
  document.getElementById('tabList').classList.remove('active');
  document.getElementById('tabFeed').classList.remove('active');
  document.getElementById('btnPark').classList.remove('active');
  document.getElementById('btnList').classList.remove('active');
  document.getElementById('btnFeed').classList.remove('active');

  if(page==='park'){
    document.getElementById('page-park').style.display='block';
    document.getElementById('page-list').style.display='none';
    document.getElementById('page-feed').style.display='none';
    document.getElementById('tabPark').classList.add('active');
    document.getElementById('btnPark').classList.add('active');
  } else if(page==='list'){
    document.getElementById('page-park').style.display='none';
    document.getElementById('page-list').style.display='block';
    document.getElementById('page-feed').style.display='none';
    document.getElementById('tabList').classList.add('active');
    document.getElementById('btnList').classList.add('active');
  } else {
    document.getElementById('page-park').style.display='none';
    document.getElementById('page-list').style.display='none';
    document.getElementById('page-feed').style.display='block';
    document.getElementById('tabFeed').classList.add('active');
    document.getElementById('btnFeed').classList.add('active');
  }
}

// ===== avatar create/edit =====
function openCreate(){
  document.getElementById('modal').style.display='flex';
  // fill modal preview
  const preview = document.getElementById('modalPreview');
  const user = state.user || {face:'üôÇ',name:''};
  preview.textContent = user.face || 'üôÇ';
  document.getElementById('avatarName').value = user.name || '';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function chooseFace(f){ document.getElementById('modalPreview').textContent = f; }
function saveAvatar(){
  const name = document.getElementById('avatarName').value.trim() || ('User'+Math.floor(Math.random()*1000));
  const face = document.getElementById('modalPreview').textContent || 'üôÇ';
  state.user = {id:uid('u'),name,face,x:50,y:70};
  saveState(); closeModal(); renderUser(); renderPark();
  document.getElementById('cardCreate').style.display='block';
  document.getElementById('chatRoot').style.display='block';
}

// ========== render functions ==========
function renderUser(){
  userArea.innerHTML = '';
  if(!state.user){
    userArea.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠';
    document.getElementById('cardCreate').style.display='none';
    document.getElementById('chatRoot').style.display='none';
    return;
  }
  const d = document.createElement('div'); d.style.display='flex';d.style.gap='10px';d.style.alignItems='center';
  const av = document.createElement('div'); av.style.width='36px';av.style.height='36px';av.style.borderRadius='8px';av.style.background='linear-gradient(180deg,var(--accent),var(--gold))';av.style.display='flex';av.style.alignItems='center';av.style.justifyContent='center';av.style.color='#111';av.style.fontWeight='800';av.textContent=state.user.face;
  const nm = document.createElement('div'); nm.textContent=state.user.name; nm.style.fontWeight='700';
  d.appendChild(av); d.appendChild(nm); userArea.appendChild(d);
  document.getElementById('cardCreate').style.display='block';
  document.getElementById('chatRoot').style.display='block';
}

function renderPark(){
  // clear existing avatars (except tree/ground)
  [...parkArea.querySelectorAll('.avatar')].forEach(n=>n.remove());

  // render other avatars from state.avatars + user avatar
  const all = [...state.avatars];
  if(state.user) all.push({...state.user,id:state.user.id}); // push user as avatar
  all.forEach(av=>{
    const el = document.createElement('div');
    el.className='avatar fade-in';
    el.style.left = av.x + '%';
    el.style.bottom = av.y + '%';
    el.style.transform = 'translate(-50%,0)';
    el.dataset.id = av.id;
    el.innerHTML = `<span>${av.face}</span>`;
    parkArea.appendChild(el);

    // bubble for the avatar's post or name
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = av.post || av.name || '';
    parkArea.appendChild(bubble);
    // position bubble above avatar
    function positionBubble(){
      const r = el.getBoundingClientRect();
      const p = parkArea.getBoundingClientRect();
      bubble.style.left = (r.left + r.width/2 - p.left) + 'px';
      bubble.style.top = (r.top - p.top) + 'px';
    }
    positionBubble();
    window.addEventListener('resize', positionBubble);
    // click to toggle bubble / open detail
    el.addEventListener('click', (e)=>{
      e.stopPropagation();
      // show bubble briefly
      document.querySelectorAll('.bubble').forEach(b=>b.classList.remove('visible'));
      bubble.classList.add('visible');
      setTimeout(()=>{ bubble.classList.remove('visible'); }, 4200);
      // if this is a user avatar, open a quick action to post review
      if(state.user && av.id === state.user.id){
        openPostQuick();
      } else {
        // show mini profile (simulate listening)
        // open details of nearest restaurant? (proto) just show on feed highlight
        highlightFeedByAvatar(av);
      }
    });

    // gentle floating animation (random)
    const rdx = (Math.random()*6 - 3);
    el.animate([
      { transform: 'translate(-50%, 0px) translateX(0px)' },
      { transform: `translate(-50%, -6px) translateX(${rdx}px)` },
      { transform: 'translate(-50%, 0px) translateX(0px)' }
    ], { duration: 3000 + Math.random()*2000, iterations: Infinity, direction: 'alternate', easing: 'ease-in-out' });

  });
}

function highlightFeedByAvatar(av){
  // find feed entries that include av.post and scroll to that post
  const matches = state.feed.filter(f=>f.avatarId === av.id || f.text?.includes(av.post));
  if(matches.length){
    showPage('feed');
    setTimeout(()=>{ const el = document.querySelector(`.post[data-id="${matches[0].id}"]`); if(el) el.scrollIntoView({behavior:'smooth',block:'center'}); },200);
  } else {
    // show small toast
    toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö avatar ‡∏ô‡∏µ‡πâ');
  }
}

function renderRestList(){
  restList.innerHTML = '';
  state.restaurants.forEach(r=>{
    const el = document.createElement('div');
    el.className = 'rest fade-in';
    el.innerHTML = `<img src="${r.img}"><div style="flex:1"><div class="name">${r.name}</div><div class="muted">${r.category}</div></div><div style="text-align:right"><div class="tag">‚≠ê ${r.rating}</div></div>`;
    el.addEventListener('click', ()=> openRestaurant(r.id));
    restList.appendChild(el);
  });
}

function openRestaurant(rid){
  // simple detail modal (use prompt for prototype)
  const r = state.restaurants.find(x=>x.id===rid);
  const menus = r.menus.map(m=>`${m.name} ‚Äî ${m.price} ‡∏ø`).join('\n');
  const action = confirm(`${r.name}\n\n‡πÄ‡∏°‡∏ô‡∏π:\n${menus}\n\n‡∏Å‡∏î‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ (Prototype)`);
  if(action){
    // open quick post with recommended text
    openPostQuick(rid);
  }
}

function renderFeed(){
  feedList.innerHTML = '';
  if(state.feed.length === 0){
    feedList.innerHTML = `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå ‡∏•‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏£‡∏Å!</div>`;
    return;
  }
  state.feed.slice().reverse().forEach(p=>{
    const el = document.createElement('div');
    el.className = 'post';
    el.dataset.id = p.id;
    el.innerHTML = `<div style="width:48px;text-align:center"><div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#111;font-weight:800">${p.face}</div></div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">${p.name}</div>
          <div class="muted" style="font-size:12px">${new Date(p.ts).toLocaleTimeString()}</div>
        </div>
        <div style="margin-top:6px">${p.text}</div>
        <div class="muted" style="margin-top:8px;font-size:12px">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: ${p.rating ? '‚≠ê'.repeat(p.rating) : '-'}</div>
      </div>`;
    feedList.appendChild(el);
  });
}

function renderScore(){
  const total = state.restaurants.reduce((s,r)=>s + (r.rating || 0),0).toFixed(1);
  document.getElementById('scoreTotal').textContent = total;
}

/* quick post flow */
function openPostQuick(rid=null){
  // simple prompt-based quick post for prototype
  if(!state.user){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Avatar ‡∏Å‡πà‡∏≠‡∏ô'); openCreate(); return; }
  const rest = rid ? (state.restaurants.find(r=>r.id===rid).name) : prompt('‡∏ó‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏ô? (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á)') || '‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
  const text = prompt('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏±‡πâ‡∏ô ‡πÜ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏ß)') || '‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏î‡∏µ';
  const rating = parseInt(prompt('‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß (1-5)', '5')) || 5;
  const post = { id: uid('post'), avatarId: state.user.id, name: state.user.name, face: state.user.face, text, rating, rest: rest, ts: Date.now() };
  state.feed.push(post);
  // attach to user avatar for bubble show
  state.user.post = text;
  // update avatars array with user's avatar if not present
  const idx = state.avatars.findIndex(a=>a.id===state.user.id);
  if(idx===-1) state.avatars.push({...state.user});
  saveState(); renderFeed(); renderPark();
  toast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏™‡∏ß‡∏ô‡πÅ‡∏•‡∏∞ feed ‡πÅ‡∏•‡πâ‡∏ß');
}

/* toast */
function toast(msg){ const t = document.createElement('div'); t.className='card small center'; t.style.position='fixed'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.bottom='110px'; t.style.zIndex=999; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2000); }

/* Chat functions */
function initChatUI(){
  document.getElementById('chatRoot').style.display = state.user ? 'block' : 'none';
  renderChatMessages();
}
function renderChatMessages(){
  const box = document.getElementById('chatMessages');
  if(!box) return;
  box.innerHTML = '';
  state.chat.slice().reverse().forEach(c=>{
    const el = document.createElement('div');
    el.style.padding='6px 8px';el.style.borderRadius='10px';el.style.background='rgba(255,255,255,0.02)';el.style.fontSize='13px';
    el.innerHTML = `<strong style="color:var(--gold)">${c.name}</strong> <span class="muted" style="font-size:12px">‚Ä¢ ${new Date(c.ts).toLocaleTimeString()}</span><div style="margin-top:6px">${c.text}</div>`;
    box.appendChild(el);
  });
}
function sendChat(){
  const inp = document.getElementById('chatInput');
  const text = inp.value.trim();
  if(!text){ return; }
  const c = { id: uid('c'), name: (state.user?state.user.name:'Guest'), text, ts: Date.now() };
  state.chat.push(c); saveState(); renderChatMessages(); inp.value=''; toast('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß');
}

/* Utilities */
function toastLong(msg){ alert(msg); }

/* init */
showPage('park');
</script>

</body>
</html>
