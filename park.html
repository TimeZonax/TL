<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TastLink - Park</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>สวนของนักผจญภัย</h1>
<div id="profile" class="card"></div>
<h2>ร้านอาหารแนะนำวันนี้</h2>
<div id="restaurant-list"></div>
<h2>คอมมูนิตี้</h2>
<div id="posts"></div>

<script type="module">
import { db } from './firebase.js';
import { doc, getDoc, collection, setDoc, getDocs, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const urlParams = new URLSearchParams(window.location.search);
const player = urlParams.get('player');
const profileDiv = document.getElementById('profile');

const playerDoc = await getDoc(doc(db,'players',player));
if(playerDoc.exists()){
  const data = playerDoc.data();
  profileDiv.innerHTML = `<div style="background:${data.bg}; display:inline-block; padding:20px; border-radius:50%; font-size:64px;">${data.emoji}</div><p>${data.name}</p>`;
}

// ตัวอย่างร้านอาหาร
const restaurants = [
  {name:'ร้าน A', menu:[{name:'ส้มตำ', price:50},{name:'ต้มยำ', price:60},{name:'ไก่ย่าง', price:80}]},
  {name:'ร้าน B', menu:[{name:'ข้าวมันไก่', price:40},{name:'ก๋วยเตี๋ยว', price:35},{name:'ผัดไทย', price:50}]},
  {name:'ร้าน C', menu:[{name:'พิซซ่า', price:120},{name:'สปาเก็ตตี้', price:90},{name:'ลาซานญ่า', price:100}]}
];

const restaurantList = document.getElementById('restaurant-list');
restaurants.forEach(r=>{
  const div = document.createElement('div'); div.className='card';
  div.innerHTML = `<h3>${r.name}</h3>`+ r.menu.map(m=>`<p>${m.name} - ${m.price} บาท <button onclick="vote('${r.name}','${m.name}')">โหวตเมนู</button></p>`).join('') + `<button onclick="vote('${r.name}')">โหวตร้าน</button>`;
  restaurantList.appendChild(div);
});

window.vote = async (restName, menuName=null)=>{
  const docRef = doc(db,'players',player);
  const playerData = (await getDoc(docRef)).data();
  playerData.votes[restName] = playerData.votes[restName]||{restaurant:false,menu:[]};
  if(menuName){ 
    if(playerData.votes[restName].menu.length>=1){ alert('โหวตเมนูครบแล้ว'); return; }
    playerData.votes[restName].menu.push(menuName);
    alert('โหวตเมนูสำเร็จ!');
  }else{
    if(playerData.votes[restName].restaurant){ alert('โหวตร้านครบแล้ว'); return; }
    playerData.votes[restName].restaurant=true;
    alert('โหวตร้านสำเร็จ!');
  }
  await setDoc(docRef, playerData);
  showPost(playerData, restName, menuName);
}

function showPost(playerData, rest, menu){
  const postsDiv = document.getElementById('posts');
  let text = menu? `${playerData.name} รีวิวเมนู ${menu} จากร้าน ${rest}` : `${playerData.name} โหวตร้าน ${rest}`;
  const div = document.createElement('div'); div.textContent=text;
  postsDiv.appendChild(div);
}
</script>
</body>
</html>
