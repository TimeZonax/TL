<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TasteLink | YumYum Park</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="park-screen">
  <h2 id="welcome-player">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏ô‡∏±‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢!</h2>
  <div id="player-profile" style="font-size:64px; width:100px; height:100px; text-align:center; line-height:100px; border-radius:50%;"></div>
  
  <div id="quests">
    <h3>‡πÄ‡∏Ñ‡∏ß‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
    <button onclick="completeQuest('review')">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏≠‡∏≤‡∏´‡∏≤‡∏£ +10</button>
    <button onclick="completeQuest('vote')">‡πÇ‡∏´‡∏ß‡∏ï‡∏£‡πâ‡∏≤‡∏ô +10</button>
    <button onclick="completeQuest('community')">‡πÇ‡∏û‡∏™‡∏ï‡πå +10</button>
  </div>

  <div id="restaurants">
    <h3>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
    <div id="restaurant-list"></div>
  </div>

  <div id="community">
    <h3>‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h3>
    <div id="posts"></div>
    <input type="text" id="post-text" placeholder="‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
    <button onclick="addPost()">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
  </div>

  <div id="ranking">
    <h3>Top ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
    <ul id="ranking-list"></ul>
  </div>

  <div id="points">‡πÅ‡∏ï‡πâ‡∏°: 0</div>
</div>

<script type="module">
import { db } from './firebase.js';
import { doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const urlParams = new URLSearchParams(window.location.search);
const playerName = urlParams.get('player');

let playerData = {};

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
async function loadPlayer() {
  const docRef = doc(db, 'players', playerName);
  const docSnap = await getDoc(docRef);
  if (docSnap.exists()) {
    playerData = docSnap.data();
    document.getElementById('welcome-player').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${playerData.name} ‡∏ô‡∏±‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢!`;
    const profile = document.getElementById('player-profile');
    profile.textContent = playerData.emoji;
    profile.style.backgroundColor = playerData.bg;
  }
}

loadPlayer();

// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£
let restaurantData = [
  {name:'‡∏£‡πâ‡∏≤‡∏ô üçî', menu:[{name:'‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå', stars:0},{name:'‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ü‡∏£‡∏≤‡∏¢', stars:0},{name:'‡∏™‡∏•‡∏±‡∏î', stars:0}]},
  {name:'‡∏£‡πâ‡∏≤‡∏ô üç£', menu:[{name:'‡∏ã‡∏π‡∏ä‡∏¥', stars:0},{name:'‡∏ã‡∏≤‡∏ä‡∏¥‡∏°‡∏¥', stars:0},{name:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏õ‡∏±‡πâ‡∏ô', stars:0}]},
  {name:'‡∏£‡πâ‡∏≤‡∏ô üçï', menu:[{name:'‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤', stars:0},{name:'‡∏û‡∏≤‡∏™‡∏ï‡πâ‡∏≤', stars:0},{name:'‡∏™‡∏•‡∏±‡∏î‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤', stars:0}]},
  {name:'‡∏£‡πâ‡∏≤‡∏ô üçú', menu:[{name:'‡∏£‡∏≤‡πÄ‡∏°‡∏á', stars:0},{name:'‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤', stars:0},{name:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', stars:0}]},
  {name:'‡∏£‡πâ‡∏≤‡∏ô ü•ó', menu:[{name:'‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏±‡∏Å', stars:0},{name:'‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ', stars:0},{name:'‡∏ô‡πâ‡∏≥‡∏™‡∏•‡∏±‡∏î', stars:0}]}
];

function renderRestaurants() {
  const container = document.getElementById('restaurant-list');
  container.innerHTML = '';
  restaurantData.forEach((r,i)=>{
    const div = document.createElement('div');
    div.innerHTML = `<h4>${r.name}</h4>`;
    r.menu.forEach((m,j)=>{
      const btn = document.createElement('button');
      btn.textContent = `‚≠ê ${m.stars} | ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡πÇ‡∏´‡∏ß‡∏ï`;
      btn.onclick = ()=> voteMenu(i,j);
      div.appendChild(document.createElement('br'));
      div.appendChild(document.createTextNode(m.name));
      div.appendChild(btn);
    });
    container.appendChild(div);
  });
}

renderRestaurants();

// ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏ß‡∏ï‡∏£‡πâ‡∏≤‡∏ô/‡πÄ‡∏°‡∏ô‡∏π
function voteMenu(ri, mi) {
  if(!playerData.votes) playerData.votes = {};
  if(!playerData.votes[restaurantData[ri].name]) playerData.votes[restaurantData[ri].name] = {store:false, menu:false};
  const voteObj = playerData.votes[restaurantData[ri].name];
  if(!voteObj.store) { voteObj.store=true; alert('‡πÇ‡∏´‡∏ß‡∏ï‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à +10'); playerData.points+=10; }
  else if(!voteObj.menu) { voteObj.menu=true; alert('‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à +10'); playerData.points+=10; }
  else { alert('‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏´‡∏ß‡∏ï‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ'); return; }

  restaurantData[ri].menu[mi].stars+=1;

  updateDoc(doc(db,'players',playerName),{votes:playerData.votes, points:playerData.points});
  document.getElementById('points').textContent = '‡πÅ‡∏ï‡πâ‡∏°: '+playerData.points;
  renderRestaurants();
  renderRanking();
}

function renderRanking() {
  const rankList = document.getElementById('ranking-list');
  let allMenu = [];
  restaurantData.forEach(r=>r.menu.forEach(m=>allMenu.push({name:m.name, stars:m.stars})));
  allMenu.sort((a,b)=>b.stars-a.stars);
  rankList.innerHTML='';
  allMenu.slice(0,5).forEach((m,i)=>{ rankList.innerHTML+=`<li>${i+1}. ${m.name} ‚≠ê${m.stars}</li>`; });
}

// ‡∏Ñ‡∏≠‡∏°‡∏°‡∏π‡∏ô‡∏¥‡∏ï‡∏µ‡πâ
function addPost() {
  const text = document.getElementById('post-text').value;
  if(!text) return;
  const post = {emoji: playerData.emoji, name:playerName, text:text};
  // ‡πÄ‡∏Å‡πá‡∏ö Firestore
  const postsRef = doc(db,'players',playerName);
  if(!playerData.reviews) playerData.reviews=[];
  playerData.reviews.unshift(post);
  updateDoc(postsRef,{reviews:playerData.reviews, points:playerData.points+5});
  document.getElementById('post-text').value='';
  renderPosts();
}

function renderPosts() {
  const container = document.getElementById('posts');
  container.innerHTML='';
  if(!playerData.reviews) return;
  playerData.reviews.forEach(p=>{
    const div = document.createElement('div');
    div.textContent = `${p.emoji} ${p.name}: ${p.text}`;
    container.appendChild(div);
  });
}

loadPlayer();
renderRestaurants();
renderPosts();
renderRanking();

</script>

</body>
</html>
